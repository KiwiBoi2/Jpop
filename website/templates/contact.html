{% extends "template.html" %} {% block title%}Contact Us{% endblock %}

{% block content %}

<h1 align="center">Contact</h1>

<div class="notes-container">
    {% if user.notes %}
        <ul class="list-group list-group-flush" id="notes">
            {% for note in user.notes %}
            <li class="list-group-item note-item" id="note-{{ note.id }}">
                <div class="note-content">
                    <div class="note-text">
                        {{ note.data }}
                    </div>
                    <div class="note-actions">
                        <button class="edit-btn" onclick="editNote({{ note.id }}, '{{ note.data|replace("'", "\\'") }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn" onclick="deleteNote({{ note.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-center text-muted">No comments yet. Be the first to leave a comment!</p>
    {% endif %}
</div>


<div class="comment-form">
    <form method="POST">
        <div class="mb-3">
            <label for="note" class="form-label"><strong>Add a Comment:</strong></label>
            <textarea name="note" id="note" class="form-control" placeholder="Write your comment here..." required></textarea>
        </div>
        <div class="text-center">
            <button class="btn btn-primary" type="submit">
                <i class="fas fa-plus"></i> Add Comment
            </button>
        </div>
    </form>
</div>
<script>
function deleteNote(noteId) {
    if (confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
        // Show loading state
        const noteElement = document.getElementById(`note-${noteId}`);
        if (noteElement) {
            noteElement.style.opacity = '0.5';
        }

        fetch(`/delete-note/${noteId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Remove the note element with animation
                if (noteElement) {
                    noteElement.style.transition = 'all 0.3s ease';
                    noteElement.style.transform = 'translateX(-100%)';
                    noteElement.style.opacity = '0';
                    setTimeout(() => {
                        noteElement.remove();
                        // Check if no notes left
                        const notesContainer = document.getElementById('notes');
                        if (!notesContainer || notesContainer.children.length === 0) {
                            location.reload();
                        }
                    }, 300);
                }
            } else {
                throw new Error(data.error || 'Failed to delete comment');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting comment: ' + error.message);
            // Restore opacity
            if (noteElement) {
                noteElement.style.opacity = '1';
            }
        });
    }
}

function editNote(noteId, currentContent) {
    // Create a more user-friendly edit dialog
    const newContent = prompt('Edit your comment:', currentContent);
    
    if (newContent && newContent.trim() !== '' && newContent !== currentContent) {
        // Show loading state
        const noteElement = document.getElementById(`note-${noteId}`);
        if (noteElement) {
            noteElement.style.opacity = '0.5';
        }

        fetch(`/edit-note/${noteId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ content: newContent.trim() })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update the note content in place
                const noteTextElement = noteElement.querySelector('.note-text');
                if (noteTextElement) {
                    noteTextElement.textContent = newContent.trim();
                    // Flash effect to show change
                    noteElement.style.backgroundColor = '#d1ecf1';
                    setTimeout(() => {
                        noteElement.style.backgroundColor = '#f8f9fa';
                    }, 500);
                }
            } else {
                throw new Error(data.error || 'Failed to edit comment');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error editing comment: ' + error.message);
        })
        .finally(() => {
            // Restore opacity
            if (noteElement) {
                noteElement.style.opacity = '1';
            }
        });
    } else if (newContent !== null && newContent.trim() === '') {
        alert('Comment cannot be empty!');
    }
}

// Add some visual feedback for form submission
document.querySelector('form').addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    const textarea = this.querySelector('#note');
    
    if (textarea.value.trim() === '') {
        e.preventDefault();
        alert('Please enter a comment before submitting.');
        return;
    }
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    submitBtn.disabled = true;
});
</script>
{% endblock %} 